<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meal Plan Generator API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .api-section {
        background: #e8f4f8;
        border-left: 4px solid #2196f3;
        padding: 20px;
        margin: 20px 0;
      }
      .code-block {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        overflow-x: auto;
      }
      .endpoint {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .method {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
      }
      .url {
        font-family: "Courier New", monospace;
        background: #f8f9fa;
        padding: 5px;
        border-radius: 3px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üçΩÔ∏è Meal Plan Generator API Documentation</h1>

      <div class="api-section">
        <h2>üì° API Endpoint</h2>
        <div class="endpoint">
          <span class="method">POST</span>
          <span class="url">/wp-json/mpg/v1/plan</span>
        </div>

        <h3>Request Headers:</h3>
        <div class="code-block">
          Content-Type: application/json X-WP-Nonce: [WordPress Nonce Token]
        </div>

        <h3>Request Body:</h3>
        <div class="code-block">
          { "sex": "female", "age": 28, "heightCm": 165, "weightKg": 60, "goal": "cut", "activity":
          "moderate", "mealsPerDay": 4, "preferences": ["high_protein", "vegetarian"], "allergies":
          "nuts, shellfish", "cookTime": "30", "budget": "$$" }
        </div>
      </div>

      <div class="api-section">
        <h2>üß™ API Test</h2>
        <p>Click the button below to test the API with sample data:</p>
        <button onclick="testAPI()">Test API Call</button>
        <button onclick="testLocalFallback()">Test Local Fallback</button>

        <div id="result" class="result" style="display: none">
          <h3>API Response:</h3>
          <pre id="response"></pre>
        </div>
      </div>

      <div class="api-section">
        <h2>üìã Response Format</h2>
        <div class="code-block">
          { "goal": "cut", "dailyTarget": { "kcal": 1800, "protein_g": 132, "fat_g": 60, "carb_g":
          180 }, "days": [ { "day": "Mon", "meals": [ { "title": "Breakfast", "item": "Oats + Greek
          Yogurt Bowl", "macros": { "kcal": 540, "p": 35, "f": 15, "c": 69 } }, { "title": "Lunch",
          "item": "Grilled Chicken + Brown Rice + Broccoli", "macros": { "kcal": 630, "p": 47, "f":
          16, "c": 74 } }, { "title": "Dinner", "item": "Baked Salmon + Sweet Potato + Green Beans",
          "macros": { "kcal": 450, "p": 29, "f": 13, "c": 45 } }, { "title": "Snack", "item": "Greek
          Yogurt + Nuts", "macros": { "kcal": 180, "p": 12, "f": 8, "c": 18 } } ], "total": {
          "kcal": 1800, "p": 123, "f": 52, "c": 206 } } ] }
        </div>
      </div>

      <div class="api-section">
        <h2>üîß PHP API Code Location</h2>
        <p><strong>File:</strong> <code>/includes/class-mpg-rest.php</code></p>
        <p><strong>Main Class:</strong> <code>MPG_REST</code></p>
        <p><strong>Key Methods:</strong></p>
        <ul>
          <li><code>register_routes()</code> - Registers the REST API endpoint</li>
          <li><code>generate_plan()</code> - Main API handler</li>
          <li><code>bmr()</code> - BMR calculation</li>
          <li><code>macro_targets()</code> - Macro calculation</li>
          <li><code>pools()</code> - Meal database</li>
        </ul>
      </div>

      <div class="api-section">
        <h2>üåê JavaScript Integration</h2>
        <p><strong>File:</strong> <code>/assets/form.js</code></p>
        <p><strong>Key Methods:</strong></p>
        <ul>
          <li><code>callAPI()</code> - Makes the API request</li>
          <li>
            <code>convertAPIResultToMealPlan()</code> - Converts API response to display format
          </li>
          <li>
            <code>extractIngredientsFromMealName()</code> - Extracts ingredients from meal names
          </li>
          <li><code>estimateCookTime()</code> - Estimates cooking time</li>
        </ul>
      </div>
    </div>

    <script>
      // Mock MPG_CFG for testing
      window.MPG_CFG = {
        root: "/wp-json/mpg/v1/",
        nonce: "test-nonce-123",
      };

      async function testAPI() {
        const resultDiv = document.getElementById("result");
        const responsePre = document.getElementById("response");

        resultDiv.style.display = "block";
        resultDiv.className = "result";
        responsePre.textContent = "Testing API call...";

        try {
          const testData = {
            sex: "female",
            age: 28,
            heightCm: 165,
            weightKg: 60,
            goal: "cut",
            activity: "moderate",
            mealsPerDay: 4,
            preferences: ["high_protein", "vegetarian"],
            allergies: "nuts, shellfish",
            cookTime: "30",
            budget: "$$",
          };

          const response = await fetch(MPG_CFG.root + "plan", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-WP-Nonce": MPG_CFG.nonce,
            },
            body: JSON.stringify(testData),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          responsePre.textContent = JSON.stringify(data, null, 2);
          resultDiv.className = "result success";
        } catch (error) {
          responsePre.textContent = `Error: ${error.message}`;
          resultDiv.className = "result error";
        }
      }

      async function testLocalFallback() {
        const resultDiv = document.getElementById("result");
        const responsePre = document.getElementById("response");

        resultDiv.style.display = "block";
        resultDiv.className = "result";
        responsePre.textContent = "Testing local fallback calculation...";

        try {
          // Simulate local calculation
          const testData = {
            sex: "female",
            age: 28,
            heightCm: 165,
            weightKg: 60,
            goal: "cut",
            activity: "moderate",
            mealsPerDay: 4,
            preferences: ["high_protein", "vegetarian"],
            allergies: "nuts, shellfish",
            cookTime: "30",
            budget: "$$",
          };

          // BMR calculation
          const bmr = 10 * testData.weightKg + 6.25 * testData.heightCm - 5 * testData.age - 161;
          const tdee = bmr * 1.55; // moderate activity
          const targetCalories = Math.round(tdee * 0.8); // cutting
          const protein = Math.round(testData.weightKg * 2.2);
          const fat = Math.round((targetCalories * 0.25) / 9);
          const carbs = Math.round((targetCalories - protein * 4 - fat * 9) / 4);

          const result = {
            goal: testData.goal,
            dailyTarget: {
              kcal: targetCalories,
              protein_g: protein,
              fat_g: fat,
              carb_g: carbs,
            },
            calculation: {
              bmr: Math.round(bmr),
              tdee: Math.round(tdee),
              method: "Mifflin-St Jeor Equation",
            },
          };

          responsePre.textContent = JSON.stringify(result, null, 2);
          resultDiv.className = "result success";
        } catch (error) {
          responsePre.textContent = `Error: ${error.message}`;
          resultDiv.className = "result error";
        }
      }
    </script>
  </body>
</html>
